//backend/jobs/askActualReminder.js.txt

const db = require("../db");
const { tgSend } = require("../utils/telegram");
const { isServiceActual, parseDateFlexible } = require("../telegram/helpers/serviceActual");

async function askActualReminder() {
  const now = new Date();

  // –Ω–µ —á–∞—â–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ 24 —á–∞—Å–∞ –Ω–∞ –æ–¥–Ω—É —É—Å–ª—É–≥—É
  const cooldownHours = 24;

  const res = await db.query(`
    SELECT
      s.id,
      s.title,
      s.details,
      s.tg_last_actual_check_at,
      p.telegram_chat_id
    FROM services s
    JOIN providers p ON p.id = s.provider_id
    WHERE
      s.category LIKE 'refused_%'
      AND s.status = 'approved'
      AND p.telegram_chat_id IS NOT NULL
  `);

  for (const row of res.rows) {
    const { id, title, details, tg_last_actual_check_at, telegram_chat_id } = row;

    // cooldown
    if (tg_last_actual_check_at) {
      const diffH = (now - new Date(tg_last_actual_check_at)) / 36e5;
      if (diffH < cooldownHours) continue;
    }

    // –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
    if (!isServiceActual(details, row)) continue;

    const text =
      `‚è≥ *–û—Ç–∫–∞–∑ –µ—â—ë –∞–∫—Ç—É–∞–ª–µ–Ω?*\n\n` +
      `üß≥ ${title}\n\n` +
      `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É—Å–ª—É–≥–∞ –Ω–µ –æ—Å—Ç–∞–ª–∞—Å—å —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º —Å—Ç–∞—Ç—É—Å–æ–º.`;

    await tgSend(telegram_chat_id, text, {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: [
          [
            { text: "‚úÖ –î–∞, –∞–∫—Ç—É–∞–ª–µ–Ω", callback_data: `svc_actual:${id}:yes` },
            { text: "‚õî –ù–µ—Ç, —Å–Ω—è—Ç—å", callback_data: `svc_actual:${id}:no` },
          ],
          [
            { text: "‚ôªÔ∏è –ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞ 7 –¥–Ω–µ–π", callback_data: `svc_actual:${id}:extend7` },
          ],
        ],
      },
    });

    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∏
    await db.query(
      `UPDATE services SET tg_last_actual_check_at = NOW() WHERE id = $1`,
      [id]
    );
  }
}

module.exports = { askActualReminder };
