const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const pool = require("../db");

const registerProvider = async (req, res) => {
  try {
    console.log("üì¶ –ü–æ–ª—É—á–µ–Ω–æ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:", req.body);
    const { name, email, password, type, location, phone, social, photo, address } = req.body;

    if (!name || !email || !password || !type || !location || !phone) {
      return res.status(400).json({ message: "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è" });
    }

    if (photo && typeof photo !== "string") {
      return res.status(400).json({ message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" });
    }

    const existingProvider = await pool.query("SELECT * FROM providers WHERE email = $1", [email]);
    if (existingProvider.rows.length > 0) {
      return res.status(400).json({ message: "Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è" });
    }

    const hashedPassword = await bcrypt.hash(password, 10);

    const newProvider = await pool.query(
      `INSERT INTO providers (name, email, password, type, location, phone, social, photo, address)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
       RETURNING id, name, email`,
      [name, email, hashedPassword, type, location, phone, social, photo, address]
    );

    const token = jwt.sign({ id: newProvider.rows[0].id }, process.env.JWT_SECRET, { expiresIn: "7d" });

    res.status(201).json({
      message: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ",
      provider: newProvider.rows[0],
      token,
    });

  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error: error.message });
  }
};

const loginProvider = async (req, res) => {
  try {
    const { email, password } = req.body;
    const provider = await pool.query("SELECT * FROM providers WHERE email = $1", [email]);

    if (provider.rows.length === 0) {
      return res.status(400).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }

    const isMatch = await bcrypt.compare(password, provider.rows[0].password);
    if (!isMatch) {
      return res.status(400).json({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å" });
    }

    const token = jwt.sign({ id: provider.rows[0].id }, process.env.JWT_SECRET, {
      expiresIn: "7d",
    });

    res.status(200).json({
      message: "–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω",
      provider: {
        id: provider.rows[0].id,
        name: provider.rows[0].name,
        email: provider.rows[0].email,
      },
      token,
    });
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};

// üëá –î–û–ë–ê–í–õ–ï–ù–û:
const getProviderProfile = async (req, res) => {
  try {
    const id = req.user.id;
    const result = await pool.query(
      "SELECT id, name, email, type, location, phone, social, photo, certificate, address FROM providers WHERE id = $1",
      [id]
    );

    if (result.rows.length === 0) {
      return res.status(404).json({ message: "–ü–æ—Å—Ç–∞–≤—â–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }

    res.status(200).json(result.rows[0]);
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};

const updateProviderProfile = async (req, res) => {
  try {
    const id = req.user.id;

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
    const current = await pool.query("SELECT * FROM providers WHERE id = $1", [id]);
    if (current.rows.length === 0) {
      return res.status(404).json({ message: "–ü–æ—Å—Ç–∞–≤—â–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }

    const old = current.rows[0];

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
    const updated = {
     name: req.body.name ?? old.name,
     location: req.body.location ?? old.location,
     phone: req.body.phone ?? old.phone,
     social: req.body.social ?? old.social,
     photo: req.body.photo ?? old.photo,
     certificate: req.body.certificate ?? old.certificate,
     address: req.body.address ?? old.address
    };


    await pool.query(
     `UPDATE providers
      SET name = $1, location = $2, phone = $3, social = $4, photo = $5, certificate = $6, address = $7
      WHERE id = $8`,
      [updated.name, updated.location, updated.phone, updated.social, updated.photo, updated.certificate, updated.address, id]
    );

    res.status(200).json({ message: "–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ" });
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error: error.message });
  }
};


// –î–û–ë–ê–í–ò–¢–¨ –£–°–õ–£–ì–£
const addService = async (req, res) => {
  try {
    const providerId = req.user.id;
    const { title, description, price, category, images, availability } = req.body;

    const result = await pool.query(
      `INSERT INTO services (provider_id, title, description, price, category, images, availability)
       VALUES ($1, $2, $3, $4, $5, $6, $7) RETURNING *`,
      [providerId, title, description, price, category, images, availability]
    );

    res.status(201).json(result.rows[0]);
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};

// –ü–û–õ–£–ß–ò–¢–¨ –£–°–õ–£–ì–ò –ü–û–°–¢–ê–í–©–ò–ö–ê
const getServices = async (req, res) => {
  try {
    const providerId = req.user.id;
    const result = await pool.query(
      "SELECT * FROM services WHERE provider_id = $1",
      [providerId]
    );
    res.json(result.rows);
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};

// –û–ë–ù–û–í–ò–¢–¨ –£–°–õ–£–ì–£
const updateService = async (req, res) => {
  try {
    const providerId = req.user.id;
    const serviceId = req.params.id;
    const { title, description, price, category, images, availability } = req.body;

    const result = await pool.query(
      `UPDATE services SET title=$1, description=$2, price=$3, category=$4, images=$5, availability=$6
       WHERE id=$7 AND provider_id=$8 RETURNING *`,
      [title, description, price, category, images, availability, serviceId, providerId]
    );

    if (result.rowCount === 0) {
      return res.status(404).json({ message: "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" });
    }

    res.json(result.rows[0]);
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};

// –£–î–ê–õ–ò–¢–¨ –£–°–õ–£–ì–£
const deleteService = async (req, res) => {
  try {
    const providerId = req.user.id;
    const serviceId = req.params.id;

    const result = await pool.query(
      "DELETE FROM services WHERE id=$1 AND provider_id=$2 RETURNING *",
      [serviceId, providerId]
    );

    if (result.rowCount === 0) {
      return res.status(404).json({ message: "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" });
    }

    res.json({ message: "–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞" });
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};

const changeProviderPassword = async (req, res) => {
  try {
    const id = req.user.id;
    const { password } = req.body;

    if (!password || password.length < 6) {
      return res.status(400).json({ message: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" });
    }

    const hashedPassword = await bcrypt.hash(password, 10);
    await pool.query("UPDATE providers SET password = $1 WHERE id = $2", [hashedPassword, id]);

    res.status(200).json({ message: "–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ" });
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è:", error.message);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error: error.message });
  }
};

// üëá –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –≥–∏–¥–∞ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–∫–∞
const getBookedDates = async (req, res) => {
  try {
    const providerId = req.provider.id;

    const result = await pool.query(
      `SELECT b.date, s.title 
       FROM bookings b 
       JOIN services s ON b.service_id = s.id 
       WHERE s.provider_id = $1`,
      [providerId]
    );

    const bookedDates = result.rows.map((row) => ({
      date: row.date.toISOString().split("T")[0],
      serviceTitle: row.title,
    }));

    res.json(bookedDates);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç:", err);
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
};


// üëá –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Å–ø–æ—Ä—Ç:
module.exports = {
  registerProvider,
  loginProvider,
  getProviderProfile,
  updateProviderProfile,
  addService,
  getServices,
  updateService,
  deleteService,
  changeProviderPassword,
  getBookedDates
};
