// backend/telegram/handlers/serviceActualHandler.js
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ "–û—Ç–∫–∞–∑ –µ—â—ë –∞–∫—Ç—É–∞–ª–µ–Ω?" (yes / no / extend7)

const db = require("../../db");
const { buildSvcActualDoneKeyboard } = require("../keyboards/serviceActual");
const { parseDateFlexible, normalizeDateInput } = require("../helpers/serviceActual");

const TZ = "Asia/Tashkent";

function safeJsonParseMaybe(v) {
  if (!v) return {};
  if (typeof v === "object") return v;
  if (typeof v === "string") {
    try {
      const parsed = JSON.parse(v);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch {
      return {};
    }
  }
  return {};
}

function getLocalDateStr(date, timeZone = TZ) {
  const fmt = new Intl.DateTimeFormat("en-CA", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  });
  // en-CA => YYYY-MM-DD
  return fmt.format(date);
}

function addDaysYYYYMMDD(baseDate, days) {
  const d = new Date(baseDate);
  d.setDate(d.getDate() + Number(days || 0));
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

async function loadServiceWithProvider(serviceId) {
  const q = await db.query(
    `
    SELECT
      s.id, s.title, s.category, s.status, s.details,
      p.id AS provider_id,
      p.telegram_chat_id,
      p.telegram_refused_chat_id,
      p.telegram_web_chat_id
    FROM services s
    JOIN providers p ON p.id = s.provider_id
    WHERE s.id = $1
    LIMIT 1
    `,
    [serviceId]
  );
  return q.rows[0] || null;
}

async function saveDetails(serviceId, details) {
  await db.query(`UPDATE services SET details = $2 WHERE id = $1`, [
    serviceId,
    JSON.stringify(details),
  ]);
}

function pushLog(details, entry) {
  const d = details || {};
  const arr = Array.isArray(d.tgActualLog) ? d.tgActualLog : [];
  arr.push(entry);
  // –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ö–≤–æ—Å—Ç
  const trimmed = arr.slice(-30);
  return { ...d, tgActualLog: trimmed };
}

/**
 * Telegraf ctx handler
 * callback_data: svc_actual:<id>:<yes|no|extend7>
 */
async function handleServiceActualCallback(ctx) {
  const data = ctx?.callbackQuery?.data;
  const m = /^svc_actual:(\d+):(yes|no|extend7)$/.exec(String(data || ""));
  if (!m) return { handled: false };

  const serviceId = Number(m[1]);
  const action = m[2];

  const fromChatId = ctx?.callbackQuery?.message?.chat?.id;
  const msgId = ctx?.callbackQuery?.message?.message_id;

  const row = await loadServiceWithProvider(serviceId);
  if (!row) {
    await ctx.answerCbQuery("–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", { show_alert: true });
    return { handled: true };
  }

  // –¥–æ—Å—Ç—É–ø: –≤–ª–∞–¥–µ–ª–µ—Ü (–ª—é–±–æ–µ –∏–∑ –ø–æ–ª–µ–π —á–∞—Ç–∞)
  const allowed = new Set(
    [row.telegram_refused_chat_id, row.telegram_chat_id, row.telegram_web_chat_id]
      .filter(Boolean)
      .map((x) => String(x))
  );

  if (allowed.size && fromChatId && !allowed.has(String(fromChatId))) {
    await ctx.answerCbQuery("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", { show_alert: true });
    return { handled: true };
  }

  const now = new Date();
  const todayTz = getLocalDateStr(now, TZ);
  const nowIso = now.toISOString();

  const details = safeJsonParseMaybe(row.details);
  const meta = details.tgActualReminder && typeof details.tgActualReminder === "object"
    ? details.tgActualReminder
    : {};

  // üîí –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —Ç–æ–π –∂–µ –∫–Ω–æ–ø–∫–µ/—Å–æ–æ–±—â–µ–Ω–∏—é
  // –µ—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≠–¢–û —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –±–∞–∑—É, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ–º
  if (meta.lastMsgId != null && msgId != null && String(meta.lastMsgId) === String(msgId)) {
    await ctx.answerCbQuery("–£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ‚úÖ", { show_alert: false });
    try {
      await ctx.editMessageReplyMarkup(buildSvcActualDoneKeyboard("‚úÖ –£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ"));
    } catch {}
    return { handled: true };
  }

  let next = { ...details };

  // –ª–æ–≥
  next = pushLog(next, {
    ts: nowIso,
    action,
    serviceId,
    chatId: fromChatId || null,
    msgId: msgId || null,
  });

  // meta –µ–¥–∏–Ω–æ–µ
  next.tgActualReminder = {
    ...(meta || {}),
    answeredDate: todayTz,
    lastAnswer: action,
    lastAnswerAt: nowIso,
    lastMsgId: msgId ?? null,
  };

  if (action === "yes") {
    next.isActive = true;

    await saveDetails(serviceId, next);
    await ctx.answerCbQuery("–û—Ç–ª–∏—á–Ω–æ ‚úÖ", { show_alert: false });

    try {
      await ctx.editMessageReplyMarkup(buildSvcActualDoneKeyboard("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ"));
    } catch {}

    return { handled: true };
  }

  if (action === "no") {
    next.isActive = false;

    await saveDetails(serviceId, next);
    await ctx.answerCbQuery("–°–Ω—è—Ç–æ ‚õî", { show_alert: false });

    try {
      await ctx.editMessageReplyMarkup(buildSvcActualDoneKeyboard("‚õî –°–Ω—è—Ç–æ"));
    } catch {}

    return { handled: true };
  }

  // extend7
  {
    // –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º expiration –Ω–∞ 7 –¥–Ω–µ–π (—Ö—Ä–∞–Ω–∏–º —Å—Ç–∞–±–∏–ª—å–Ω–æ YYYY-MM-DD)
    // –±–∞–∑—É –±–µ—Ä–µ–º: —Ç–µ–∫—É—â–µ–µ expiration –µ—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–æ –∏ –≤ –±—É–¥—É—â–µ–º, –∏–Ω–∞—á–µ —Å–µ–≥–æ–¥–Ω—è
    const cur = next.expiration ? parseDateFlexible(next.expiration) : null;
    const base = cur && !Number.isNaN(cur.getTime()) ? cur : now;

    // –µ—Å–ª–∏ expiration –±—ã–ª –≤ –ø—Ä–æ—à–ª–æ–º ‚Äî —Ç–æ–∂–µ –æ—Ç today
    const base2 = base.getTime() < now.getTime() ? now : base;
    const newExp = addDaysYYYYMMDD(base2, 7);

    next.expiration = newExp;
    next.isActive = true;

    await saveDetails(serviceId, next);
    await ctx.answerCbQuery("–ü—Ä–æ–¥–ª–µ–Ω–æ –Ω–∞ 7 –¥–Ω–µ–π üåø", { show_alert: false });

    try {
      await ctx.editMessageReplyMarkup(buildSvcActualDoneKeyboard(`üåø –î–æ ${normalizeDateInput(newExp) || newExp}`));
    } catch {}

    return { handled: true };
  }
}

module.exports = { handleServiceActualCallback };
